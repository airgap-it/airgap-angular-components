import { BitcoinSegwitTransactionSignResponse } from '@airgap/bitcoin'
import { MainProtocolSymbols } from '@airgap/coinlib-core'
import { IACMessageDefinitionObjectV3, IACMessageType } from '@airgap/serializer'
import { BCURTypesGenerator } from './bc-ur-generator'

describe('BCURTypesGenerator', () => {
  let generator: BCURTypesGenerator

  beforeEach(() => {
    generator = new BCURTypesGenerator()
  })

  it('should create', () => {
    expect(generator).toBeTruthy()
  })

  it('should generate an account share message', async () => {
    const data: IACMessageDefinitionObjectV3 = {
      id: 79370700,
      protocol: MainProtocolSymbols.BTC_SEGWIT,
      type: IACMessageType.AccountShareResponse,
      payload: {
        publicKey: 'zpub6s1D4v39zP2hNjAtAFRZ7J59W8tK9txcqgSM1STVQHq2AyUoM3eyXqCfXbweMCT5c69EQCz4rMgZQeMyKWfCvfeQVLCGQeCsGVdWkmQ3D4F',
        isExtendedPublicKey: true,
        derivationPath: "m/84'/0'/0'/0/1",
        masterFingerprint: '6f01ffc8',
        isActive: true,
        groupId: '6f01ffc8',
        groupLabel: 'Test'
      }
    }

    await generator.create([data], 300, 150)
    const part = await generator.nextPart()
    expect(part).toBe(
      'UR:CRYPTO-ACCOUNT/OEADCYJLADZMSPAOLYTAADMWTAADDLONAXHDCLAXBNCYCPMEJNKBRFDTBGHPLPTTWDEHRTRDOTHGFHYNYASACWAYPELNNLSWSGPYKNGRAAHDCXRPVTUOCKCTRPOYMDLGESRLGLKSGDDARPPTECJZJOWZADRPDAMSDPGUHFAXWNMHMOAMTAADDYOTADLECSGHYKAEYKAEYKAEWKADWKAOCYLTKBDKMDAXAXAYCYVWPSJOUYASIEGHIHJKJYJOYLHLZS'
    )
  })

  it('should generate a PSBT message', async () => {
    const payload: BitcoinSegwitTransactionSignResponse = {
      transaction:
        '70736274ff01007102000000014742514ef9428f07093aa888e0d58379710184b4710bcf30908b3a3a23f3d2e10000000000ffffffff02e803000000000000160014c16de3baf47144696c05fa15091e9f11519f489b6f2b000000000000160014a5d83aa0d8d9cc1e32a91d62ef32c7819d9885ce000000000001011f39300000000000001600143dda6e9696921f540201d2e42e5b34e7a8244e072202024cab9363e24e4af8fbc87641a681bb05f7308b77ea4890ae783fffecfb6a5e5f483045022100fdbbd20fdd149ad4d2d1987cf3014898395c2976b9193afd5df26330b684d2c4022059cf67e7701e7e7b02c609b662741cac42d372852ea6c62e81ea151d2e6e780a012206024cab9363e24e4af8fbc87641a681bb05f7308b77ea4890ae783fffecfb6a5e5f186f01ffc854000080000000800000008000000000010000000000220203746125bcb2379238d6421d513a50a3a198693c2b84aac1260737f73c6afe9e6b186f01ffc8540000800000008000000080010000000100000000',
      accountIdentifier: ''
    }

    const data: IACMessageDefinitionObjectV3 = {
      id: 49255571,
      type: IACMessageType.TransactionSignResponse,
      protocol: MainProtocolSymbols.BTC_SEGWIT,
      payload
    }

    await generator.create([data], 300, 150)

    const part1 = await generator.nextPart()
    const part2 = await generator.nextPart()

    expect(part1).toBe(
      'UR:CRYPTO-PSBT/1-2/LPADAOCFADLNCYNLASLEWLHDSRHKADLSJOJKIDJYZMADAEJSAOAEAEAEADFLFWGYGLYTFWMYATASFTPDLOVTTLLSKKJSADLRQZJSBDTKDYMHLUFTFTCNWFTDVYAEAEAEAEAEZMZMZMZMAOVSAXAEAEAEAEAEAECMAEBBSEJNVLRDWKJSFYINJZAHZSBZASCKNEBYGYNEFDNDJLDNAEAEAEAEAEAECMAEBBONTPFTNBTPTASFCKEYPTCAIDWSEYSTLYNTMKLPTOAEAEAEAEAEADADCTESDYAEAEAEAEAEAECMAEBBFSTNJTMTMTMOCTGHAOADTDVEDMHPEEVDPDDKGLATCPAOAOGSPYMUIAVOGLGEYAZOSPKOFPOLLYRKAHYLDYLUKTWDFDMHPLKSFHZMWPZOIMHYHEFDAABZZEWF'
    )
    expect(part2).toBe(
      'UR:CRYPTO-PSBT/2-2/LPAOAOCFADLNCYNLASLEWLHDSRDYFEAOCLAEZCRKTDBSUTBBNYTYTDTTMKKEWFADFDMKESHHDTKORHCFFTZCHLWZIADYRPLRTDSSAOCXHKTKIOVDJOCKKBKGAOSWASRPIDJYCEPSFWTEJPLPDMOLSWDMLYWDBZCADMJTKSBKADCPAMAOGSPYMUIAVOGLGEYAZOSPKOFPOLLYRKAHYLDYLUKTWDFDMHPLKSFHZMWPZOIMHYHECSJLADZMSPGHAEAELAAEAEAELAAEAEAELAAEAEAEAEADAEAEAEAEAECPAOAXJYHSDARFPREMMOETTBFWCAGYFTGDOTOYMKINFNDNLRPKSEDSATEMYLFNIMZENNJECSJLADZMSPGHAEAELAAEAEAELAAEAEAELAADAEAEAEADAEAEAEAEFTMNBAJY'
    )
  })
})
